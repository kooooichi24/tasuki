# Tasuki 襷

[English version (README.md)](./README.md)

[Cursor ブログ「自動運転するコードベースに向けて」](https://cursor.com/ja/blog/self-driving-codebases) を参考にした、マルチエージェント協調のためのハーネスです。駅伝の **襷（たすき）** のように、エージェントが結果を次に渡していく設計です。

- **プランナー** がタスクを生成し、**ワーカー** が専用リポジトリコピーで実行
- スコープが大きい場合は **サブプランナー** に再帰的に委譲
- 完了時は **ハンドオフ** 1 本でプランナーに返し、グローバル同期なしで情報を伝播
- モデル上限到達時は **フォールバックチェーン** で自動切替
- 全メッセージ・アクションをタイムスタンプ付きでログし、分析・再生可能

詳細は [DESIGN.md](./DESIGN.md) を参照してください。

## アーキテクチャ

```
ユーザー指示
    ↓
┌─────────────────┐
│ ルートプランナー │  全体を見てタスクを出す（コードは書かない）
└──┬──────────┬───┘
   ↓          ↓
 タスク    サブプランナー  スコープの一部を委譲（再帰的に生成可能）
   ↓          ↓
┌──────┐  ┌──────┐
│ワーカー│  │ワーカー│  専用リポジトリコピーで独立作業
└──┬───┘  └──┬───┘
   ↓          ↓
 ハンドオフ  ハンドオフ  結果・メモ・懸念を 1 本のドキュメントで返す
   ↓          ↓
 依頼元プランナーが受信 → 次のラウンドへ
```

## インストール

```bash
# PyPI から（公開後）
pip install tasuki

# または GitHub から直接
pip install git+https://github.com/yourname/tasuki.git

# uvx でインストールなしに即実行（推奨）
uvx tasuki run
```

### 開発用（ソースから）

```bash
git clone https://github.com/yourname/tasuki.git
cd tasuki
uv sync   # または pip install -e .
```

## 設定

### プロジェクトの初期化

```bash
# 任意のプロジェクトディレクトリで
tasuki init
```

`.tasuki/config/tasuki.yaml` と `.tasuki/config/prompts/` が生成されます。  
設定ファイルの探索順: カレントの `.tasuki/config/` → `~/.config/tasuki/` → パッケージ内デフォルト。

`.tasuki/config/tasuki.yaml` を編集します。

### LLM プロバイダー（Cursor CLI がデフォルト）

デフォルトでは **Cursor CLI**（`agent -p`）経由で LLM を呼び出します。API キー不要で Cursor の契約内で利用できます。

```bash
# Cursor CLI のインストール
curl https://cursor.com/install -fsS | bash

# 認証
agent login
```

```yaml
llm:
  provider: cursor # cursor | openai
  model: gpt-5.2-codex-xhigh # Cursor CLI のモデル ID を使用（確認: agent --list-models）
```

OpenAI API を使う場合は `provider: openai` に変更し、`OPENAI_API_KEY` を設定してください。

> **注意:** モデル名は表示名（例: "GPT-5.2 Codex Extra High"）ではなく、Cursor CLI の ID（例: `gpt-5.2-codex-xhigh`）を指定します。  
> `agent --list-models` で利用可能な ID 一覧を確認できます。

### フォールバック（モデル上限到達時の自動切替）

メインモデルが上限に達すると、リトライ後に自動でフォールバックします。

```
gpt-5.2-codex-xhigh → opus-4.6-thinking → auto
```

```yaml
llm:
  fallback_models:
    - opus-4.6-thinking # Claude 4.6 Opus (Thinking)
    - auto # Cursor の自動選択（最終手段）
  retry:
    max_retries: 3 # 同一モデルでの最大リトライ回数
    base_delay_sec: 2 # エクスポネンシャルバックオフ（2, 4, 8...秒）
    max_delay_sec: 60
```

### その他の設定

```yaml
concurrency:
  max_workers: 2 # 並行ワーカー数（上限到達を抑えるため控えめ）
```

対象リポジトリは `tasuki run` を実行したカレントディレクトリが自動的に使われます。

プランナー／ワーカー用のシステムプロンプトは `.tasuki/config/prompts/` で調整可能です。

## 使い方

```bash
# 対話的にセッションを開始
tasuki run

# または uvx で即実行
uvx tasuki run

# ヘルプ
tasuki help
```

起動すると以下の流れで進みます:

1. ユーザー指示を入力
2. 最大ラウンド数を指定（デフォルト 3）
3. 各ラウンドが自動で実行され、完了状況が表示される

## ワーカーのツールループ

ワーカーは LLM と繰り返しやり取りしながら、3 つのツールでリポジトリを操作します（最大 20 イテレーション）:

| ツール      | 機能               | 引数                                                                        |
| ----------- | ------------------ | --------------------------------------------------------------------------- |
| `run_cmd`   | シェルコマンド実行 | `command`（必須）、`timeout`（省略可、最大 300 秒）                         |
| `read_file` | ファイル読み取り   | `path`（リポジトリルートからの相対パス）                                    |
| `edit_file` | ファイル編集       | `path` + `content`（全文上書き）、または `path` + `old` + `new`（差分置換） |

ワーカーが全ての作業を終えると、ツールコールなしでハンドオフ文書（`# Summary` で始まる Markdown）を出力します。

## 1 ラウンドの流れ

1. **ルートプランナー** — ユーザー指示 + 前回ハンドオフからタスク一覧を生成。委譲があればサブプランナーを登録
2. **サブプランナー** — 未実行またはハンドオフが届いたサブを実行し、追加タスク生成
3. **ワーカー並行実行** — ペンディングタスクを最大 2 並行で実行。専用リポジトリコピーでツールループを回し、ハンドオフを返す
4. **ハンドオフ収集** — 完了タスクの結果を保存。次ラウンドでプランナーに渡される

複数ラウンドが自動で繰り返され、各ラウンドでプランナーは前回のハンドオフを受け取って次のタスクを計画します。

## 記事の設計思想との対応

| 記事の教訓                 | このプロジェクトでの実装                                     |
| -------------------------- | ------------------------------------------------------------ |
| インテグレーターを置かない | なし。ワーカーが直接ハンドオフで返す                         |
| 共有ロックを使わない       | ワーカーは専用リポジトリコピーで独立作業                     |
| 100% 正しさを要求しない    | エラー許容、収束前提の設計                                   |
| 可観測性を最初から重視     | JSONL ログで全アクション・メッセージをタイムスタンプ付き記録 |
| 新鮮さの確保               | scratchpad 書き直し、自己省察リマインダーをプロンプトに含む  |
| スコープ量は具体的数値で   | プロンプトに「Generate 20-100 tasks」等を明記                |

## 今後の拡張

- ヘッドレス実行（`--instruction "..." --rounds 5` のような CLI オプション）
- ワーカーのツール追加（`git_commit`, `run_tests` 等）
- サブプランナーの並行実行

## ライセンス

MIT
